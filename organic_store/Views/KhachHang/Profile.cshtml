@model organic_store.Models.KhachHang
@using organic_store.Models
@{
    ViewBag.Title = "Profile";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // Đã loại bỏ ViewBag.HoaDonList
}

<link rel="stylesheet" href="~/assets/css/_Layout.css">
<link rel="stylesheet" href="~/assets/css/responsive.css">
<link rel="stylesheet" href="~/assets/css/Profile.css">

<div class="profile-container container">
    <div class="profile-header">
        <div class="d-flex align-items-center">
            <img src="https://ui-avatars.com/api/?name=@Model.HoTen.Replace(" ", "+")&size=120&background=2e7d32&color=fff"
                 alt="Avatar" class="profile-avatar">
            <div class="ms-4">
                <h1 class="profile-name">@Model.HoTen</h1>
                <p class="profile-email mb-0">
                    <i class="fas fa-envelope me-2"></i>@Model.Email
                </p>
            </div>
        </div>
        <div class="profile-stats">
            <div class="stat-item">
                <span class="stat-number">@ViewBag.SoDonHang</span>
                <span class="stat-label">Đơn hàng</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">5</span>
                <span class="stat-label">Yêu thích</span>
            </div>
            <div class="stat-item">
                <span class="stat-number">@Model.LoaiKH</span>
                <span class="stat-label">Hạng thành viên</span>
            </div>
        </div>
    </div>

    <div class="profile-content">
        <div class="profile-sidebar">
            <ul class="sidebar-menu">
                <li><a href="javascript:void(0)" class="menu-item active" data-target="info"><i class="fas fa-user"></i><span>Thông tin cá nhân</span></a></li>
                <li><a href="javascript:void(0)" class="menu-item" data-target="orders"><i class="fas fa-shopping-bag"></i><span>Đơn hàng của tôi</span></a></li>
                <li><a href="javascript:void(0)" class="menu-item" data-target="favorites"><i class="fas fa-heart"></i><span>Sản phẩm yêu thích</span></a></li>
                <li><a href="javascript:void(0)" class="menu-item" data-target="addresses"><i class="fas fa-map-marker-alt"></i><span>Địa chỉ giao hàng</span></a></li>
                <li><a href="javascript:void(0)" class="menu-item" data-target="password"><i class="fas fa-lock"></i><span>Đổi mật khẩu</span></a></li>
                <li><a href="javascript:void(0)" class="menu-item" data-target="notifications"><i class="fas fa-bell"></i><span>Thông báo</span></a></li>
                <li><a href="@Url.Action("Logout", "Account")" style="color: #f44336;"><i class="fas fa-sign-out-alt" style="color: #f44336;"></i><span>Đăng xuất</span></a></li>
            </ul>
        </div>

        <div class="profile-main">

            @* TAB 1: THÔNG TIN CÁ NHÂN (Tải sẵn và active mặc định) *@
            <div class="tab-content" id="info">
                @Html.Partial("_PersonalInfoPartial", Model)
            </div>

            @* TAB 2: ĐƠN HÀNG CỦA TÔI (Sử dụng div rỗng để tải bằng AJAX) *@
            <div class="tab-content" id="orders" data-loaded="false" data-url="@Url.Action("GetOrderListPartial", "KhachHang")">
                <div class="text-center p-5"><i class="fas fa-spinner fa-spin me-2"></i> Đang tải đơn hàng...</div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {

            // Hàm chuyển đổi tab (chỉ xử lý CSS/JS)
            function switchTab(targetId) {
                // Xóa trạng thái active cũ trên Sidebar và Nội dung
                $('.menu-item').removeClass('active');
                $('.tab-content').removeClass('active');

                // Gán active mới
                const $targetMenuItem = $(`.menu-item[data-target="${targetId}"]`);
                const $targetTab = $('#' + targetId);

                $targetMenuItem.addClass('active');
                $targetTab.addClass('active');
            }

            // Logic xử lý chuyển Tab
            $('.menu-item').click(function (e) {
                e.preventDefault();

                const targetId = $(this).data('target');
                const $targetTab = $('#' + targetId);

                // Chỉ xử lý các tab có data-target (bỏ qua link Đăng xuất)
                if (targetId) {

                    // 1. Chuyển đổi trạng thái hiển thị (CSS)
                    switchTab(targetId);

                    // 2. LOGIC TẢI AJAX (Lazy Loading)
                    const isLoaded = $targetTab.data('loaded') === 'true'; // Chuyển sang boolean
                    const url = $targetTab.data('url');

                    // Nếu chưa tải VÀ có URL để tải
                    if (!isLoaded && url) {

                        $targetTab.data('loaded', 'true'); // Đánh dấu là đã tải/đang tải
                        $targetTab.html('<div class="text-center p-5"><i class="fas fa-spinner fa-spin me-2"></i> Đang tải dữ liệu...</div>'); // Hiển thị spinner

                        $.ajax({
                            url: url,
                            type: 'GET',
                            success: function (result) {
                                $targetTab.html(result); // Đổ nội dung Partial View vào tab
                            },
                            error: function () {
                                $targetTab.html('<div class="alert alert-danger">Lỗi khi tải dữ liệu. Vui lòng thử lại.</div>');
                                $targetTab.data('loaded', 'false'); // Cho phép tải lại nếu lỗi
                            }
                        });
                    }
                }
            });

            // FIX: Kích hoạt nội dung tab mặc định khi tải trang
            const defaultTarget = $('.menu-item.active').data('target');
            if (defaultTarget) {
                switchTab(defaultTarget);
            }
        });
    </script>
}