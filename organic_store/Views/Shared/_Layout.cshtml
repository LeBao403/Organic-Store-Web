@using organic_store.Models
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organic Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="~/assets/css/_Layout.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body>

    @* Lấy thông tin cần thiết từ Session và Request *@
    @{
        var currentKhachHang = Session["CurrentUser"] as organic_store.Models.KhachHang;

        // Lấy danh mục từ ViewBag (Giả định Controller đã thiết lập)
        var categories = ViewBag.Categories as List<organic_store.Models.DanhMuc> ?? new List<organic_store.Models.DanhMuc>();

        // Lấy MaCH hiện tại từ Request.QueryString (Nếu đang ở trang Index)
        string currentMaCH = Request.QueryString["maCH"] ?? "ALL";
    }

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="@Url.Action("Index", "Home")">Organic Shop</a>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("AboutUs", "Home")">Giới thiệu</a>
                    </li>

                    @* TẠO LIÊN KẾT DANH MỤC ĐỘNG *@
                    @* Sử dụng mã DM cố định nếu ViewBag trống (để đảm bảo menu luôn hiện) *@

                    @if (!categories.Any())
                    {
                        // Dùng danh mục tĩnh (ví dụ khi đang ở trang khác Home/Index)
                        <li class="nav-item"><a class="nav-link category-link" data-madm="DM01" href="@Url.Action("Index", "Home", new { maDM = "DM01", maCH = currentMaCH })">Rau củ tươi</a></li>
                        <li class="nav-item"><a class="nav-link category-link" data-madm="DM02" href="@Url.Action("Index", "Home", new { maDM = "DM02", maCH = currentMaCH })">Trái cây</a></li>
                        <li class="nav-item"><a class="nav-link category-link" data-madm="DM04" href="@Url.Action("Index", "Home", new { maDM = "DM04", maCH = currentMaCH })">Gia Vị Thiên Nhiên</a></li>
                        <li class="nav-item"><a class="nav-link category-link" data-madm="DM03" href="@Url.Action("Index", "Home", new { maDM = "DM03", maCH = currentMaCH })">Ngũ Cốc Hữu Cơ</a></li>
                    }
                    else
                    {
                        // Dùng danh mục động từ ViewBag
                        foreach (var category in categories)
                        {
                            <li class="nav-item" data-madm="@category.MaDM">
                                <a class="nav-link category-link"
                                   href="@Url.Action("Index", "Home", new { maDM = category.MaDM, maCH = currentMaCH })">
                                    @category.TenDM
                                </a>
                            </li>
                        }
                    }

                </ul>
            </div>

            <div class="d-flex align-items-center">

                <div class="search-bar me-3">
                    <i class="fas fa-search text-muted"></i>
                    <input type="text" class="form-control-plaintext live-search"
                           data-url="@Url.Action("Search", "Home")"
                           data-target="#homeResult"
                           placeholder="Tìm kiếm ...">
                </div>

                @* LOGIC HIỂN THỊ TÊN HOẶC ICON USER *@
                <div class="me-3">
                    @if (currentKhachHang != null)
                    {
                        <span class="text-dark">
                            <a href="@Url.Action("CheckLogin", "Account")" class="text-dark text-decoration-none" title="Trang cá nhân">
                                <span class="fw-bold">Hi, @currentKhachHang.HoTen</span>
                            </a>
                        </span>
                        <a href="@Url.Action("Logout", "Account")" class="ms-2 text-danger small" title="Đăng xuất">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    }
                    else
                    {
                        <a href="@Url.Action("CheckLogin", "Account")" class="text-dark" title="Đăng nhập / Đăng ký">
                            <i class="fas fa-user"></i>
                        </a>
                    }
                </div>
                @* KẾT THÚC LOGIC *@

                <a href="#" class="text-dark position-relative">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">1</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container body-content">
        @RenderBody()
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div>
                    <h5>Về Chúng Tôi</h5>
                    <ul>
                        <li><a href="#">Giới thiệu</a></li>
                        <li><a href="#">Liên hệ</a></li>
                        <li><a href="#">Chính sách</a></li>
                    </ul>
                </div>
                <div>
                    <h5>Hỗ Trợ</h5>
                    <ul>
                        <li><a href="#">Hướng dẫn mua hàng</a></li>
                        <li><a href="#">Chính sách đổi trả</a></li>
                        <li><a href="#">Hỏi đáp</a></li>
                    </ul>
                </div>
                <div>
                    <h5>Kết Nối</h5>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Organic Shop. Mang niềm vui đến cho mọi nhà.</p>
            </div>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("scripts", required: false)
    <script>
        // Navbar hide on scroll down, show on scroll up
        let lastScroll = 0;
        const navbar = document.querySelector('.navbar');
        window.addEventListener('scroll', () => {
            let currentScroll = window.pageYOffset;
            if (currentScroll > lastScroll && currentScroll > 100) {
                navbar.style.transform = 'translateY(-100%)';
            } else {
                navbar.style.transform = 'translateY(0)';
            }
            lastScroll = currentScroll;
        });

        // =======================================================
        // CẬP NHẬT LIVE SEARCH URL (Sử dụng jQuery)
        // =======================================================
        $(document).ready(function () {

            // Hàm lấy MaDM hiện tại từ URL (Chỉ lấy khi đang ở trang Index)
            const getMaDMFromUrl = () => {
                // Kiểm tra nếu đang ở trang chủ (Index)
                if (window.location.pathname.toLowerCase().includes('/home/index') ||
                    window.location.pathname === '/')
                {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get('maDM') || 'ALL';
                }
                return 'ALL';
            };

            // Hàm cập nhật data-url cho Live Search (Áp dụng cho mọi trang)
            const updateSearchUrl = () => {
                // Lấy MaCH từ dropdown Cửa hàng (chỉ tồn tại trên trang Index)
                const maCH = $('#storeSelect').val() || '@currentMaCH';

                // Lấy MaDM hiện tại từ URL
                const maDM = getMaDMFromUrl();

                // Gán URL cho Live Search, bao gồm cả MaCH và MaDM
                const searchUrl = '@Url.Action("Search", "Home")' + '?maCH=' + maCH + '&maDM=' + maDM;
                $('.live-search').attr('data-url', searchUrl);
            };

            // Chạy khi load
            updateSearchUrl();

            // Nếu dropdown cửa hàng tồn tại, cập nhật URL khi thay đổi
            $('#storeSelect').change(updateSearchUrl);
        });
    </script>
</body>
</html>