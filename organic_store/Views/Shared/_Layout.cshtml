@using organic_store.Models
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organic Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="~/assets/css/_Layout.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body>
<<<<<<< HEAD
=======

    @* Lấy thông tin cần thiết từ Session và Request *@
>>>>>>> main
    @{
        var currentKhachHang = Session["CurrentUser"] as organic_store.Models.KhachHang;

        // Lấy danh mục từ ViewBag (Giả định Controller đã thiết lập)
        var categories = ViewBag.Categories as List<organic_store.Models.DanhMuc> ?? new List<organic_store.Models.DanhMuc>();

        // Lấy MaCH hiện tại từ Request.QueryString (Nếu đang ở trang Index)
        string currentMaCH = Request.QueryString["maCH"] ?? "ALL";
    }
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="@Url.Action("Index", "Home")">Organic Shop</a>
            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav">
<<<<<<< HEAD
                    <li class="nav-item"><a class="nav-link" href="#">Giới thiệu</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Rau củ tươi</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Trái cây</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Gia Vị Thiên Nhiên</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Ngũ Cốc Hữu Cơ</a></li>
=======
                    <li class="nav-item">
                        <a class="nav-link" href="@Url.Action("AboutUs", "Home")">Giới thiệu</a>
                    </li>

                    @* TẠO LIÊN KẾT DANH MỤC ĐỘNG *@
                    @* Sử dụng mã DM cố định nếu ViewBag trống (để đảm bảo menu luôn hiện) *@

                    @if (!categories.Any())
                    {
                        // Dùng danh mục tĩnh (ví dụ khi đang ở trang khác Home/Index)
                        <li class="nav-item"><a class="nav-link category-link" data-madm="DM01" href="@Url.Action("Index", "Home", new { maDM = "DM01", maCH = currentMaCH })">Rau củ tươi</a></li>
                        <li class="nav-item"><a class="nav-link category-link" data-madm="DM02" href="@Url.Action("Index", "Home", new { maDM = "DM02", maCH = currentMaCH })">Trái cây</a></li>
                        <li class="nav-item"><a class="nav-link category-link" data-madm="DM04" href="@Url.Action("Index", "Home", new { maDM = "DM04", maCH = currentMaCH })">Gia Vị Thiên Nhiên</a></li>
                        <li class="nav-item"><a class="nav-link category-link" data-madm="DM03" href="@Url.Action("Index", "Home", new { maDM = "DM03", maCH = currentMaCH })">Ngũ Cốc Hữu Cơ</a></li>
                    }
                    else
                    {
                        // Dùng danh mục động từ ViewBag
                        foreach (var category in categories)
                        {
                            <li class="nav-item" data-madm="@category.MaDM">
                                <a class="nav-link category-link"
                                   href="@Url.Action("Index", "Home", new { maDM = category.MaDM, maCH = currentMaCH })">
                                    @category.TenDM
                                </a>
                            </li>
                        }
                    }

>>>>>>> main
                </ul>
            </div>

            <div class="d-flex align-items-center">
                <div class="search-bar me-3">
                    <i class="fas fa-search text-muted"></i>
                    <input type="text" class="form-control-plaintext live-search"
                           data-url="@Url.Action("Search", "Home")"
                           data-target="#homeResult"
                           placeholder="Tìm kiếm ...">
                </div>

                <div class="me-3">
                    @if (currentKhachHang != null)
                    {
<<<<<<< HEAD
                        <a href="@Url.Action("CheckLogin", "Account")" class="text-dark text-decoration-none fw-bold">
                            Hi, @currentKhachHang.HoTen
=======
                        <span class="text-dark">
                            <a href="@Url.Action("CheckLogin", "Account")" class="text-dark text-decoration-none" title="Trang cá nhân">
                                <span class="fw-bold">Hi, @currentKhachHang.HoTen</span>
                            </a>
                        </span>
                        <a href="@Url.Action("Logout", "Account")" class="ms-2 text-danger small" title="Đăng xuất">
                            <i class="fas fa-sign-out-alt"></i>
>>>>>>> main
                        </a>
                    }
                    else
                    {
                        <a href="@Url.Action("CheckLogin", "Account")" class="text-dark" title="Đăng nhập / Đăng ký">
                            <i class="fas fa-user"></i>
                        </a>
                    }
                </div>

                <a href="/Cart/Index" class="nav-link position-relative">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-count" class="badge bg-danger position-absolute top-0 start-100 translate-middle">0</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container body-content">
        @RenderBody()
    </div>

    <footer>
        <div class="container text-center py-3 border-top">
            <p>&copy; 2025 Organic Shop. Mang niềm vui đến cho mọi nhà.</p>
        </div>
    </footer>

    

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("scripts", required: false)


    <script>
        
        function updateCartCount(storeId) {
            $.get("@Url.Action("GetCartCount", "Cart")", { maCH: storeId }, function (res) {
                if (res && res.count !== undefined) {
                    $("#cart-count").text(res.count);
                } else {
                    $("#cart-count").text("0");
                }
            }).fail(function() {
                
                $("#cart-count").text("0");
            });
        }

        $(document).ready(function () {
            
            var initialStore = $("#storeSelect").val() || sessionStorage.getItem("selectedStore") || "ALL";
            $("#storeSelect").val(initialStore);
            updateCartCount(initialStore);

            $(document).on("change", "#storeSelect", function () {
                var storeId = $(this).val();
                sessionStorage.setItem("selectedStore", storeId);

                
                $.post("@Url.Action("SetSelectedStore", "Home")", { maCH: storeId }, function () {
                    
                    window.location.href = '@Url.Action("Index", "Home")?maCH=' + storeId;
                });
            });


           
            $(document).on("click", ".add-to-cart-btn", function (e) {
                e.preventDefault();
                var btn = $(this);
                
                var storeId = $("#storeSelect").val() || sessionStorage.getItem("selectedStore");

                if (!storeId || storeId === "ALL") {
                    alert("Vui lòng chọn cửa hàng trước khi thêm sản phẩm vào giỏ hàng!");
                    return;
                }

                
                var quantity = parseInt(btn.data("quantity")) || parseInt($("#quantity").val()) || 1;
                var maxStock = parseInt(btn.data("stock")) || 0;
                if (maxStock < 0) {
                    maxStock = 0;
                }
                if (quantity > maxStock) {
                    alert(`Số lượng không được vượt quá ${maxStock}!`);
                    return;
                }

                var product = {
                    MaSP: btn.data("id"),
                    TenSP: btn.data("name"),
                    GiaBan: btn.data("price"),
                    HinhAnhURL: btn.data("image"),
                    Quantity: quantity,
                    MaCH: storeId
                };

                $.ajax({
                    url: "@Url.Action("AddToCart", "Cart")",
                    type: "POST",
                    data: product,
                    success: function (res) {
                        if (res.redirect) {
                            
                            alert("Bạn cần đăng nhập để thêm sản phẩm vào giỏ hàng!");
                            window.location.href = res.redirect;
                        }
                        else if (res.success) {
                            
                            updateCartCount(storeId);
                            alert("Đã thêm " + product.TenSP + " vào giỏ hàng (" + $("#storeSelect option:selected").text() + ")");
                        } else {
                            
                            alert(res.message || "❌ Thêm sản phẩm thất bại!");
                        }
                    },
                    error: function () {
                        alert("Lỗi mạng hoặc lỗi server khi thêm sản phẩm!");
                    }
                });
            });
            
        });

        // =======================================================
        // CẬP NHẬT LIVE SEARCH URL (Sử dụng jQuery)
        // =======================================================
        $(document).ready(function () {

            // Hàm lấy MaDM hiện tại từ URL (Chỉ lấy khi đang ở trang Index)
            const getMaDMFromUrl = () => {
                // Kiểm tra nếu đang ở trang chủ (Index)
                if (window.location.pathname.toLowerCase().includes('/home/index') ||
                    window.location.pathname === '/')
                {
                    const urlParams = new URLSearchParams(window.location.search);
                    return urlParams.get('maDM') || 'ALL';
                }
                return 'ALL';
            };

            // Hàm cập nhật data-url cho Live Search (Áp dụng cho mọi trang)
            const updateSearchUrl = () => {
                // Lấy MaCH từ dropdown Cửa hàng (chỉ tồn tại trên trang Index)
                const maCH = $('#storeSelect').val() || '@currentMaCH';

                // Lấy MaDM hiện tại từ URL
                const maDM = getMaDMFromUrl();

                // Gán URL cho Live Search, bao gồm cả MaCH và MaDM
                const searchUrl = '@Url.Action("Search", "Home")' + '?maCH=' + maCH + '&maDM=' + maDM;
                $('.live-search').attr('data-url', searchUrl);
            };

            // Chạy khi load
            updateSearchUrl();

            // Nếu dropdown cửa hàng tồn tại, cập nhật URL khi thay đổi
            $('#storeSelect').change(updateSearchUrl);
        });
    </script>
</body>
</html>
